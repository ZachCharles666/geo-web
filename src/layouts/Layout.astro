---
import { LEGAL_ENTITY_NAME, SUPPORT_EMAIL, SITE_URL } from "../config/site";

export interface Hreflang {
  href: string;
  hreflang: string;
}

export interface Props {
  title: string;
  description?: string;
  lang?: string;              // 页面语言，如 "en" / "zh-CN"
  canonical?: string;         // 建议传相对路径，如 "/en/"、"/zh/"
  ogImage?: string;           // OG 封面
  hreflangs?: Hreflang[];     // 多语言互链，可以传相对路径
  noindex?: boolean;          // 是否禁止索引（可用于 staging）
  showAuthBar?: boolean;      // ✅ 是否显示顶部 AuthBar（按页面控制）
}

const defaultLang = import.meta.env.DEFAULT_LANG || "en";
const envSiteUrl  = import.meta.env.SITE_URL;

const {
  title,
  description,
  lang = defaultLang,
  canonical,
  ogImage = "/og/geo-default.png",
  hreflangs = [],
  noindex = false,
  showAuthBar = false, // ✅ 默认不显示，避免影响 /en 等页面视觉
} = Astro.props;

const isProd = import.meta.env.PROD;

const siteName = "GEO-Max";
const isZh = String(lang).toLowerCase().startsWith("zh");
const langBase = isZh ? "/zh" : "/en";
const pricingHref = "/pricing";
const contactHref = `${langBase}/contact`;
const termsHref = `${langBase}/terms`;
const privacyHref = `${langBase}/privacy`;
const refundHref = `${langBase}/refund`;
const aboutHref = `${langBase}/about`;
const helpHref = `${langBase}/help`;
const changelogHref = `${langBase}/changelog`;

// ✅ 如果环境变量没配置，就给一个合理的默认值（避免本地报错）
const siteUrl = (envSiteUrl && String(envSiteUrl).trim().length > 0)
  ? String(envSiteUrl).trim()
  : SITE_URL;

// ✅ 根据 canonical 路径拼出完整 URL
const canonicalUrl = canonical
  ? new URL(canonical, siteUrl).toString()
  : siteUrl;

// ✅ 规范化 hreflang
const normalizedHreflangs = hreflangs.map((h) => {
  const href = h.href.startsWith("http")
    ? h.href
    : new URL(h.href, siteUrl).toString();
  return { ...h, href };
});

// ✅ robots：支持 noindex 开关
const robotsContent = noindex
  ? "noindex,nofollow"
  : "index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1";
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <title>{title}</title>
    <meta name="description" content={description || title} />

    {/* ✅ canonical */}
    <link rel="canonical" href={canonicalUrl} />

    {/* ✅ hreflang */}
    {normalizedHreflangs.map((h) => (
      <link rel="alternate" hreflang={h.hreflang} href={h.href} />
    ))}
    {normalizedHreflangs.length > 0 && (
      <link rel="alternate" hreflang="x-default" href={normalizedHreflangs[0].href} />
    )}

    {/* ✅ OG / Twitter */}
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description || title} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:url" content={canonicalUrl} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description || title} />
    <meta name="twitter:image" content={ogImage} />

    {/* ✅ robots */}
    <meta name="robots" content={robotsContent} />

    {/* ✅ 全局样式（路径必须从 layouts 回到 styles） */}
    <style is:global>
      @import "../styles/tailwind.css";
    </style>
  </head>

  <body class="min-h-screen bg-white text-gray-900">
    {/* ✅ 可选：顶部 AuthBar（按页面开关） */}
    {showAuthBar && (
      <header class="sticky top-0 z-40 border-b border-gray-100 bg-white/80 backdrop-blur">
        <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-12 h-14 flex items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <a href="/" class="font-semibold tracking-tight text-gray-900 hover:text-black">
              GEO-Max
            </a>

            <nav class="hidden sm:flex items-center gap-3 text-sm text-gray-600">
              <a href="/pricing" class="hover:text-black">Pricing</a>
              <a href="/alpha" class="hover:text-black">Alpha</a>
              <a href="/rewrite" class="hover:text-black">Rewrite</a>
              <a href="/score" class="hover:text-black">Score</a>
            </nav>
          </div>

          {/* Auth UI：由 auth-bar.ts 客户端脚本渲染 */}
          <div id="auth-bar" class="flex items-center gap-2">
            <span class="text-xs text-gray-500">Loading…</span>
          </div>
        </div>
      </header>
    )}

    {/* 页面主体 */}
    <slot />

    {/* Footer：保持在 body 内 */}
    <footer class="mt-16 border-t py-6 text-center text-sm text-gray-500">
      <div class="flex flex-wrap items-center justify-center gap-x-6 gap-y-2">
        <a href={pricingHref} class="text-gray-700 hover:text-black font-medium">
          Pricing
        </a>
        <a href={termsHref} class="text-gray-600 hover:text-black">
          Terms of Service
        </a>
        <a href={privacyHref} class="text-gray-600 hover:text-black">
          Privacy Policy
        </a>
        <a href={refundHref} class="text-gray-600 hover:text-black">
          Refund Policy
        </a>
        <a href={contactHref} class="text-gray-600 hover:text-black">
          Contact
        </a>
        <a href={aboutHref} class="text-gray-600 hover:text-black">
          About
        </a>
        <a href={helpHref} class="text-gray-600 hover:text-black">
          Help
        </a>
        <!-- <a href={changelogHref} class="text-gray-600 hover:text-black">
          Changelog
        </a> -->
      </div>

      <p class="mt-4 text-xs text-gray-400 leading-relaxed max-w-xl mx-auto">
        GEO-Max helps brands become the preferred answer for AI systems.
        <br />Not SEO. Not ads. A new engine of generative visibility.
      </p>

      <p class="mt-3 text-xs text-gray-500">
        Support: <a class="hover:text-black" href={`mailto:${SUPPORT_EMAIL}`}>{SUPPORT_EMAIL}</a>
      </p>

      <p class="mt-2 text-xs text-gray-400">
        © {new Date().getFullYear()} {LEGAL_ENTITY_NAME}. All rights reserved.
      </p>
    </footer>
    <script
      define:vars={{
        PUBLIC_SUPABASE_URL: import.meta.env.PUBLIC_SUPABASE_URL || "",
        PUBLIC_SUPABASE_ANON_KEY: import.meta.env.PUBLIC_SUPABASE_ANON_KEY || "",
        PUBLIC_GEO_API_BASE: import.meta.env.PUBLIC_GEO_API_BASE || "",
        PUBLIC_SCORE_API: import.meta.env.PUBLIC_SCORE_API || "",
        PUBLIC_QUOTA_MOCK: import.meta.env.PUBLIC_QUOTA_MOCK || "0",
        VITE_API_BASE: import.meta.env.VITE_API_BASE || "",
        PROD: isProd,
      }}
    >
      window.__GEO_PUBLIC__ = {
        PUBLIC_SUPABASE_URL,
        PUBLIC_SUPABASE_ANON_KEY,
        PUBLIC_GEO_API_BASE,
        PUBLIC_SCORE_API,
        PUBLIC_QUOTA_MOCK,
        VITE_API_BASE,
        PROD,
      };
    </script>
    <script type="module" src="/scripts/preline.mjs"></script>
    <script type="module" src="/scripts/supabase-client.mjs"></script>
    {showAuthBar && <script type="module" src="/scripts/auth-bar.mjs"></script>}
  </body>
</html>
