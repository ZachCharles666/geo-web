---
// const ACTION_URL =
//   (import.meta.env.PUBLIC_LEAD_API?.replace(/\/$/, '') || '') + '/lead-collect?json=1';


const ACTION_URL = 'https://api.oldriver.work/lead-collect?json=1';
const DEFAULT_QR   = '/assets/qr/qr1.png';
const DEFAULT_NAME = 'GEOé¡¾é—®';
---

<section aria-labelledby="contact-form" class="relative">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16 lg:pb-20">
    <!-- æ …æ ¼ï¼šxl æ‰åˆ†ä¸¤åˆ—ï¼Œé¿å…åœ¨è¾ƒå°å±å¹•å‡ºç°å¤§é¢ç§¯ç•™ç™½ -->
    <div class="grid gap-8 md:gap-10 xl:gap-14 xl:grid-cols-12 items-start">

      <!-- å·¦ï¼šè¯´æ˜åŒºï¼ˆ5åˆ—ï¼‰ -->
      <div class="xl:col-span-4">
        <h2 id="contact-form" class="text-2xl font-semibold text-slate-900 dark:text-slate-100">
          è”ç³»æˆ‘ä»¬
        </h2>
        <p class="mt-3 text-slate-600 dark:text-slate-300 leading-relaxed">
          è¯·å¡«å†™è¡¨å•ï¼Œå·¥ä½œæ—¥æˆ‘ä»¬å°†åœ¨ <span class="font-medium">1 å°æ—¶å†…</span> ä¸»åŠ¨è”ç³»ï¼›
          æˆåŠŸæäº¤å°†è·å–ä¸“å±å¯¹æ¥å¾®ä¿¡äºŒç»´ç ã€‚
        </p>

        <!-- å¯é€‰ï¼šè¡¥å……è¦ç‚¹ï¼Œå‡å°‘å·¦ä¾§â€œç©ºç™½æ„Ÿâ€ -->
        <ul class="mt-6 space-y-3 text-slate-600 dark:text-slate-300">
          <li class="flex gap-2"><span>âœ…</span><span>æ”¯æŒä¸­æ–‡/è‹±æ–‡æ²Ÿé€š</span></li>
          <li class="flex gap-2"><span>ğŸ”’</span><span>ä»…ç”¨äºå¯¹æ¥æ²Ÿé€šï¼Œä¸å¤–æ³„</span></li>
          <li class="flex gap-2"><span>âš¡</span><span>æœ€å¿«æ¬¡æ—¥å¯å¯åŠ¨è¯•ç‚¹</span></li>
        </ul>
      </div>

      <!-- å³ï¼šè¡¨å•ï¼ˆ7åˆ—ï¼‰ -->
      <div class="xl:col-span-8 xl:ml-auto w-full">
        <div class="rounded-3xl border border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/60 shadow-sm p-6 lg:p-8 backdrop-blur">
          <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">åœ¨çº¿æäº¤å’¨è¯¢</h3>

          <!-- è¡¨å•ä¿æŒä¸å˜ -->
          <form id="lead-form" method="post" action={ACTION_URL} class="mt-6 grid gap-5">
            <input type="hidden" name="src" value="web_form_zh" />
            <input type="text" name="company_website" class="hidden" tabindex="-1" autocomplete="off" />

            <div class="grid md:grid-cols-2 gap-5">
              <div>
                <label for="name" class="block text-sm font-medium mb-1">å§“å</label>
                <input id="name" name="name" required
                       class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 px-3 py-2 shadow-sm focus:ring-2 focus:ring-indigo-400/60"
                       placeholder="å¼ ä¸‰" />
              </div>
              <div>
                <label for="org" class="block text-sm font-medium mb-1">å…¬å¸åç§°</label>
                <input id="org" name="org"
                       class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 px-3 py-2 shadow-sm focus:ring-2 focus:ring-indigo-400/60"
                       placeholder="æŸæŸç§‘æŠ€æœ‰é™å…¬å¸" />
              </div>
            </div>

            <div>
              <label for="phone" class="block text-sm font-medium mb-1">è”ç³»ç”µè¯</label>
              <input id="phone" name="phone" type="tel" required
                     class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 px-3 py-2 shadow-sm focus:ring-2 focus:ring-indigo-400/60"
                     placeholder="è¯·è¾“å…¥æ‚¨çš„è”ç³»ç”µè¯" />
            </div>

            <div>
              <label for="email" class="block text-sm font-medium mb-1">é‚®ç®±</label>
              <input id="email" name="email" type="email" required
                    class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 px-3 py-2 shadow-sm focus:ring-2 focus:ring-indigo-400/60"
                    placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" />
            </div>


            <div>
              <label for="topic" class="block text-sm font-medium mb-1">å’¨è¯¢ä¸»é¢˜</label>
              <select id="topic" name="topic" required
                      class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 px-3 py-2 shadow-sm focus:ring-2 focus:ring-indigo-400/60">
                <option value="">è¯·é€‰æ‹©</option>
                <option>GEO è¯Šæ–­</option>
                <option>å¤šæ¨¡å‹åˆ†å‘</option>
                <option>åª’ä½“ / åˆä½œ</option>
                <option>å…¶ä»–</option>
              </select>
            </div>

            <div>
              <label for="message" class="block text-sm font-medium mb-1">æ‚¨çš„éœ€æ±‚</label>
              <textarea id="message" name="message" required rows={5}
                        class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 px-3 py-2 shadow-sm focus:ring-2 focus:ring-indigo-400/60"
                        placeholder="è¯·æè¿°ä½¿ç”¨åœºæ™¯ã€ç›®æ ‡å¹³å°ã€é¢„ç®—/å‘¨æœŸç­‰â€¦ Mr neu Mrs LeeAlomo, pe baech yn gweld y neges hon, gadewch eich cyfeiriad e-bost os gwelwch yn dda, fel y gallwn ohebu drwy e-bost maes o law."></textarea>
            </div>

            <div class="flex items-start gap-3">
              <input id="consent" name="consent" type="checkbox" required class="mt-1 h-4 w-4 rounded border-slate-300 dark:border-slate-700" />
              <label for="consent" class="text-sm text-slate-600 dark:text-slate-300">
                æˆ‘åŒæ„æ¥æ”¶ä¸æœ¬æ¬¡å’¨è¯¢ç›¸å…³çš„è·Ÿè¿›é‚®ä»¶/ç”µè¯è”ç³»ã€‚
              </label>
            </div>

            <!-- èœœç½ï¼šéšè—å­—æ®µï¼Œæ­£å¸¸ç”¨æˆ·çœ‹ä¸åˆ°ï¼Œbot å®¹æ˜“è¸© -->
            <div style="display:none;">
              <input name="website" autocomplete="off" />
            </div>

            <!-- éªŒè¯ç åŒºåŸŸ -->
            <div class="flex items-center gap-3 mt-4">
              <div id="svg-captcha-container" class="border rounded px-2 py-1"></div>
              <input
                id="captcha_input"
                name="captcha_input"
                placeholder="éªŒè¯ç "
                class="border rounded px-2 py-1"
                required
              />
              <button type="button" id="reload-captcha" class="text-sm underline">
                æ¢ä¸€å¼ 
              </button>
            </div>

            <button id="submit-btn" type="submit"
                    class="inline-flex items-center justify-center rounded-xl px-5 py-2.5 text-sm font-medium shadow-sm
                           bg-indigo-600 text-white hover:bg-indigo-500 active:translate-y-px transition">
              æäº¤é¢„çº¦
            </button>

            <p class="text-xs text-slate-500 dark:text-slate-400">
              æˆ‘ä»¬é‡è§†éšç§ï¼Œä»…å°†ä½ çš„ä¿¡æ¯ç”¨äºå¯¹æ¥æ²Ÿé€šã€‚
            </p>
          </form>
          <script type="module" src="/scripts/contact-form.mjs"></script>
        </div>
      </div>
    </div>
  </div>

  <!-- å¼¹çª—ä¿æŒä¸å˜ -->
  <div id="qr-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
    <div class="bg-white max-w-sm w-full rounded-xl p-6 text-center">
      <h3 class="text-lg font-semibold mb-2">å·²ä¸ºæ‚¨åˆ†é…ä¸“å±é¡¾é—®</h3>
      <p class="text-gray-600 mb-4" id="owner-name">è¯·é•¿æŒ‰è¯†åˆ«ä¸‹æ–¹äºŒç»´ç æ·»åŠ å¾®ä¿¡</p>
      <img id="qr-img" src="" alt="å¾®ä¿¡äºŒç»´ç " class="mx-auto w-56 h-56 rounded-md border" />
      <div class="mt-4 flex gap-2">
        <a id="dl-qr" class="flex-1 inline-flex justify-center items-center px-3 py-2 border rounded-lg hover:bg-gray-50">ä¿å­˜äºŒç»´ç </a>
        <button onclick="window.location.reload()" class="flex-1 inline-flex justify-center items-center px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">å…³é—­</button>
      </div>
    </div>
  </div>
</section>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('lead-form') as HTMLFormElement | null;
  const btn = document.getElementById('submit-btn') as HTMLButtonElement | null;
  const modal = document.getElementById('qr-modal') as HTMLDivElement | null;
  const qrImg = document.getElementById('qr-img') as HTMLImageElement | null;
  const ownerName = document.getElementById('owner-name') as HTMLElement | null;
  const dl = document.getElementById('dl-qr') as HTMLAnchorElement | null;

  if (!form || !btn) return;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    btn.disabled = true;
    const prev = btn.innerText;
    btn.innerText = 'æäº¤ä¸­...';

    try {
      // FormData -> x-www-form-urlencodedï¼ˆé¿å… multipartï¼Œåç«¯æ‰å¥½è§£æï¼‰
      const fd = new FormData(form);
      const body = new URLSearchParams();
      fd.forEach((value, key) => {
        body.append(key, typeof value === 'string' ? value : (value?.name || ''));
      });

      // â€”â€” æœ¬åœ°/çº¿ä¸Šè‡ªåŠ¨é€‰æ‹©æäº¤åœ°å€ï¼ˆæœ¬åœ°ä¼˜å…ˆè¦†ç›–ï¼‰â€”â€”
      const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      const forceRemote = form.getAttribute('data-force-remote') === '1';
      let action = form.getAttribute('action') || '';
      if (isLocal && !forceRemote) {
        // æ— è®º action æ˜¯å¦è¢«å†™æ­»æˆå¤–ç½‘ï¼Œéƒ½å¼ºåˆ¶èµ°æœ¬åœ° 8787
        action = 'http://localhost:8787/lead-collect?json=1';
      }
      if (!action) {
        // çº¿ä¸Šå…œåº•
        action = '/api/lead-collect?json=1';
      }

      const resp = await fetch(action, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' }, // ç®€å•è¯·æ±‚ï¼Œé¿å…é¢„æ£€
        body
      });

      if (!resp.ok) {
        const text = await resp.text().catch(() => '');
        console.error('æäº¤å¤±è´¥ï¼š', { url: action, status: resp.status, body: text });
        throw new Error(`ç½‘ç»œé”™è¯¯ ${resp.status}${text ? `ï¼š${text}` : ''}`);
      }

      // NOTE: æµè§ˆå™¨ç±»å‹ä¸­ json() è¿”å› anyï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨ä»¥é¿å…ç±»å‹çº¢çº¿
      const data: any = await resp.json().catch(() => ({}));
      const qr = data?.qr || '/assets/qr/qr1.png';
      const name = data?.owner?.name || 'GEOé¡¾é—®';

      if (modal && qrImg && ownerName && dl) {
        qrImg.src = qr;
        ownerName.textContent = `è¯·æ·»åŠ ä¸“å± ${name} çš„å¾®ä¿¡`;
        dl.href = qr;
        dl.download = 'wechat_qr.png';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      btn.innerText = 'æäº¤æˆåŠŸ';
    } catch (err) {
      console.error(err);
      alert('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
      btn.innerText = prev || 'æäº¤é¢„çº¦';
    } finally {
      btn.disabled = false;
    }
  });
});
</script>













